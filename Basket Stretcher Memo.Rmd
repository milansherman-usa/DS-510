---
title: "AO Basket Stretcher Analysis"
author: "October 21-24 Promotion"
date: "11/29/2021"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)

file <- paste("Q:/Business Analytics/MARKETING - OTHERS KEEP OUT/AO Analysis/AO Basket Stretcher October")
knitr::opts_knit$set(root.dir = normalizePath(file))

theme_ben <- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      text=element_text(size=base_size,  family="serif"),
      plot.title = element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      # Les axes
      axis.title = element_text(size = rel(0.85), face = "bold"),
      axis.text = element_text(size = rel(0.70), face = "bold"),
      axis.line = element_line(color = "black"),
      # La légende
      legend.title = element_text(size = rel(0.85), face = "bold"),
      legend.text = element_text(size = rel(0.70), face = "bold"),
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      legend.position="none",
      # Les étiquettes dans le cas d'un facetting
      strip.background = element_rect(fill = "#17252D", color = "#17252D"),
      strip.text = element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
    )
}

conversion_plot <- function(df, tier) {
  ggplot(df,   aes(x=condition, ymin = `lower.bound`, 
         ymax = `upper.bound`, lower = `lower.bound`,
         upper = `upper.bound`, middle = `conversion`,
         fill = condition)) + 
  geom_boxplot(stat = 'identity') +
  geom_text(data=df, aes(label=upper_pct_rd,y=upper.bound+0.005))+
  geom_text(data=df, aes(label=lower_pct_rd,y=lower.bound-0.005))+
  scale_fill_manual(
    # name = "Condition: ",
                    # magma with 8 classes
                    values = c("#e41a1c",
                               "#377eb8",
                               "#4daf4a",
                               "#984ea3",
                               "#ff7f00",
                               # "#ffff33",
                               "#a65628",
                               "#f781bf"))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0.15,.35)) +
  labs(title = paste0("$",tier," Basket Tier Conversion Rate Confidence Intervals"),
       subtitle = "Differences are not statistically significant relative to control group",
       x = " ",
       y = "Percent of Customers with an AO Basket",
       caption = "95% Confidence Interval"
  )}

basket_size_plot <- function(df, tier, lowerbound, upperbound) {
  ggplot(df,   aes(x=condition, ymin = `lower.bound`, 
         ymax = `upper.bound`, lower = `lower.bound`,
         upper = `upper.bound`, middle = `spend`,
         fill = condition)) + 
  geom_boxplot(stat = 'identity') +
  geom_text(data=df, aes(label=upper.bound.dollar,y=upper.bound+2))+
  geom_text(data=df, aes(label=lower.bound.dollar,y=lower.bound-2))+
  scale_fill_manual(
    # name = "Condition: ",
                    # magma with 8 classes
                    values = c("#e41a1c",
                               "#377eb8",
                               "#4daf4a",
                               "#984ea3",
                               "#ff7f00",
                               # "#ffff33",
                               "#a65628",
                               "#f781bf"),

                    guide = guide_legend(
                      direction = "horizontal",))+
  scale_y_continuous(labels = scales::dollar_format(accuracy = 1), limits = c(lowerbound, upperbound)) +
  labs(title = paste0("$", tier, " Basket Tier Basket Size Confidence Intervals"),
       subtitle = "Differences are not statistically significant relative to control group",
       x = "",
       y = "Average Basket Size",
       caption = "95% Confidence Interval"
  )}

```
# Overall Takeaways
* We did not see any lift in targeted customers compared to a control group
  + This was true for any combination of tier, promotion, and/or channel
* Analysis of non-AO (random) customers also demonstrated no effect
* A total of 679 customers activated this promotion at a total cost of $10,437.20

# Methodology

### Design Features of this Promotion
* $100 tier: Customers with an average basket size between $50 and $75 
* $150 tier: Customers with an average basket size between $75 and $125 
* $200 tier: Customers with an average basket size between $125 and $175 
* Added 20% random customer to each tier who had not shopped AO (based on in-store average basket size)
* Held out a 10% control group in each tier
* Two promotions: 5% and 10% ($100 tier had only 10%)
* Two channels: email and push notification (some customers received both)

## Analysis
* We used a logistic regression model to analyze propensity to buy at each tier level
* We used a linear regression model to analyze basket size among customer who purchased at each tier level
<!-- * We used a difference in differences model to determine if customers who redeemed the promotion exhibited different AO behavior after the promotion  -->


```{r}
post_data <- read.csv("post_hoc_data.csv")
target_data <- read.csv("target_data.csv")
target_promo <- read.csv("target_promo.csv")
qualified <- read.csv("qualified.csv")
items <- read.csv("items.csv")
diff <- read.csv("pre_post.csv")
```
\newpage

# Campaign Numbers

```{r message=FALSE, warning=FALSE}
library(janitor)
library(gt)

target_data %>% 
  tabyl(tier, condition) %>% 
  gt() %>%
     tab_header(
    title = "All Customers") %>%
  cols_label(
    tier = "Tier",
    Control = "Control",
    Test = "Targeted") %>% 
  fmt_number(
    columns = c(Control, Test),
    decimals = 0) %>%
  fmt_currency(
    columns = tier,
    decimals = 0)
  


```


```{r message=FALSE, warning=FALSE}

library(dplyr)
library(gt)

email <- target_data %>% 
  filter(channel == 'Email') %>%
  tabyl(tier, promotion) %>% 
  mutate(channel = 'email')

push <- target_data %>% 
  filter(channel == 'Push') %>% 
  tabyl(tier, promotion) %>% 
  mutate(channel = 'push')

both <- target_data %>% 
  filter(channel == 'Both') %>% 
  tabyl(tier, promotion) %>% 
  mutate(channel = 'both')

bind_rows(email, push, both) %>% 
  select(-channel) %>% 
  gt() %>% 
  tab_header(
    title = "Target by Channel and Tier") %>%
  cols_label(
    tier = " ",
    `0.05` = "5% off",
    `0.1` = "10% off") %>% 
  tab_row_group(
    label = "Email",
    rows = 1:3) %>%
  tab_row_group(
    label = "Push",
    rows = 4:6) %>%
  tab_row_group(
    label = "Both",
    rows = 7:9) %>% 
    fmt_number(
    columns = c(`0.05`, `0.1`),
    decimals = 0) %>%
  fmt_currency(
    columns = tier,
    decimals = 0)
```
\newpage
# AO Purchase Analysis

* We analyzed the conversion rates and average order size by tier, channel, and experimental condition (targeted vs. control)
  + Conversion rates were based on all customers in a given tier, channel, and experimental condition
  + Basket size was based on customers who made an AO purchase (whether they made a qualifying purchase or not)

```{r message=FALSE, warning=FALSE}

library(dplyr)
library(ggplot2)
library(scales)

AO_100 <- target_promo %>% 
  filter(tier == '100' & customer_type == 'AO') %>% 
  group_by(push, email, five_percent, ten_percent) %>% 
  summarise(conversion = mean(AO_flag),
            customers = n(),
            SE = sd(AO_flag)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = conversion - margin.error, 
            upper.bound = conversion + margin.error) %>% 
  mutate(condition = case_when(push == 0 & email == 0 & five_percent == 0 & ten_percent == 0 ~ 'control',
                               push == 0 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'email',
                               push == 1 & email == 0 & five_percent == 0 & ten_percent == 1 ~ 'push',
                               push == 1 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'both')) %>% 
  ungroup() %>% 
  select(condition, conversion, lower.bound, upper.bound)


AO_100$condition <- factor(AO_100$condition, ordered = TRUE, 
                             levels = c('email','push', 'both','control'))

AO_100 <- AO_100%>%
  mutate(conversion_pct_rd = round(conversion, 3),
         lower_pct_rd = round(lower.bound, 3),
         upper_pct_rd = round(upper.bound, 3))

AO_100$conversion_pct_rd <- percent(AO_100$conversion_pct_rd, .1)
AO_100$lower_pct_rd <- percent(AO_100$lower_pct_rd, .1)
AO_100$upper_pct_rd <- percent(AO_100$upper_pct_rd, .1)

conversion_plot(AO_100, "100") + theme_ben() 
```

```{r message=FALSE, warning=FALSE}
library(formattable)
library(dplyr)
library(ggplot2)

AO_100_sales <- target_promo %>% 
  filter(tier == '100' & AO_flag == 1& customer_type == 'AO') %>% 
  group_by(push, email, five_percent, ten_percent) %>% 
  summarise(spend = mean(AO_sales),
            customers = n(),
            SE = sd(AO_sales)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = spend - margin.error,
            upper.bound = spend + margin.error) %>%
  mutate(condition = case_when(push == 0 & email == 0 & five_percent == 0 & ten_percent == 0 ~ 'control',
                               push == 0 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'email',
                               push == 1 & email == 0 & five_percent == 0 & ten_percent == 1 ~ 'push',
                               push == 1 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'both')) %>%
  ungroup() %>% 
  select(condition, spend, lower.bound, upper.bound)

AO_100_sales <- AO_100_sales %>% 
  mutate(lower.bound.dollar = currency(lower.bound),
         upper.bound.dollar = currency(upper.bound))
AO_100_sales$condition <- factor(AO_100_sales$condition, ordered = TRUE, levels = c('email', 'push', 'both', 'control'))

lowerbound <- min(AO_100_sales$lower.bound) - 10
upperbound <- max(AO_100_sales$upper.bound) + 10


basket_size_plot(AO_100_sales, "100", lowerbound, upperbound) + theme_ben() 
```

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(gt)
post_data %>% 
  filter(tier == '100' & period == 'pre') %>% 
  select(-tier, - period, -X) %>% 
  rename(Customers = customers, Trips = trips, `Items per Trip` = items_per_trip, `Average Price per Item` = avg_price, `Basket Size` = basket_size) %>% 
  pivot_longer(-condition, names_to = c("Pre Campaign"), values_to = c("Treatment"))%>% 
  pivot_wider(names_from = condition, values_from = Treatment) %>% 
  gt() %>% 
     tab_header(
    title = "$100 Basket Tier") %>% 
  cols_label(
    Test = "Treatment") %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(1),
    decimals = 0) %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(2),
    decimals = 2) %>% 
  fmt_number(   
    columns = c(Control, Test),
    rows = c(3),
    decimals = 1) %>% 
  fmt_currency(
    columns = c(Control, Test),
    rows = c(4,5),
    decimals = 2) %>% 
  tab_footnote(
    footnote = md("Pre campaign includes the 60 days prior to the start of the campaign"), 
    locations = cells_column_labels("Pre Campaign"))

```

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(gt)
post_data %>% 
  filter(tier == '100' & period == 'during') %>% 
  select(-tier, - period, -X) %>% 
  rename(Customers = customers, Trips = trips, `Items per Trip` = items_per_trip, `Average Price per Item` = avg_price, `Basket Size` = basket_size) %>% 
  pivot_longer(-condition, names_to = c("During Campaign"), values_to = c("Treatment"))%>% 
  pivot_wider(names_from = condition, values_from = Treatment) %>% 
  gt() %>% 
     tab_header(
    title = "$100 Basket Tier") %>% 
  cols_label(
    Test = "Treatment") %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(1),
    decimals = 0) %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(2),
    decimals = 2) %>% 
  fmt_number(   
    columns = c(Control, Test),
    rows = c(3),
    decimals = 1) %>% 
  fmt_currency(
    columns = c(Control, Test),
    rows = c(4,5),
    decimals = 2) %>% 
  tab_footnote(
    footnote = md("Control and Targeted groups are nearly identical"),
    locations = cells_column_labels("Control"))
```

```{r message=FALSE, warning=FALSE}

library(dplyr)
library(ggplot2)
library(scales)

AO_150 <- target_promo %>% 
  filter(tier == '150'& customer_type == 'AO') %>% 
  group_by(push, email, five_percent, ten_percent) %>% 
  summarise(conversion = mean(AO_flag),
            customers = n(),
            SE = sd(AO_flag)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = conversion - margin.error, 
            upper.bound = conversion + margin.error) %>% 
  mutate(condition = case_when(push == 0 & email == 0 & five_percent == 0 & ten_percent == 0 ~ 'control',
                               push == 0 & email == 1 & five_percent == 1 & ten_percent == 0 ~ 'email 5%',
                               push == 0 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'email 10%',
                               push == 1 & email == 0 & five_percent == 1 & ten_percent == 0 ~ 'push 5%',
                               push == 1 & email == 0 & five_percent == 0 & ten_percent == 1 ~ 'push 10%',
                               push == 1 & email == 1 & five_percent == 1 & ten_percent == 0 ~ 'both 5%',
                               push == 1 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'both 10%')) %>% 
  ungroup() %>% 
  select(condition, conversion, lower.bound, upper.bound)


AO_150$condition <- factor(AO_150$condition, ordered = TRUE, 
                             levels = c('email 5%', 'email 10%', 'push 5%', 'push 10%','both 5%', 'both 10%','control'))

AO_150 <- AO_150%>%
  mutate(conversion_pct_rd = round(conversion, 5),
         lower_pct_rd = round(lower.bound, 5),
         upper_pct_rd = round(upper.bound, 5))

AO_150$conversion_pct_rd <- percent(AO_150$conversion_pct_rd, digits = 1)
AO_150$lower_pct_rd <- percent(AO_150$lower_pct_rd, digits = 1)
AO_150$upper_pct_rd <- percent(AO_150$upper_pct_rd, digits = 1)

conversion_plot(AO_150, "150") + theme_ben() 
```

```{r message=FALSE, warning=FALSE}
library(formattable)
library(dplyr)
library(ggplot2)

AO_150_sales <- target_promo %>% 
  filter(tier == '150' & AO_flag == 1 & customer_type == 'AO') %>% 
  group_by(push, email, five_percent, ten_percent) %>% 
  summarise(spend = mean(AO_sales),
            customers = n(),
            SE = sd(AO_sales)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = spend - margin.error,
            upper.bound = spend + margin.error) %>%
  mutate(condition = case_when(push == 0 & email == 0 & five_percent == 0 & ten_percent == 0 ~ 'control',
                               push == 0 & email == 1 & five_percent == 1 & ten_percent == 0 ~ 'email 5%',
                               push == 0 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'email 10%',
                               push == 1 & email == 0 & five_percent == 1 & ten_percent == 0 ~ 'push 5%',
                               push == 1 & email == 0 & five_percent == 0 & ten_percent == 1 ~ 'push 10%',
                               push == 1 & email == 1 & five_percent == 1 & ten_percent == 0 ~ 'both 5%',
                               push == 1 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'both 10%')) %>% 
  ungroup() %>% 
  select(condition, spend, lower.bound, upper.bound)


AO_150_sales <- AO_150_sales %>% 
  mutate(lower.bound.dollar = currency(lower.bound),
         upper.bound.dollar = currency(upper.bound))

AO_150_sales$condition <- factor(AO_150_sales$condition, ordered = TRUE, 
                                 levels = c('email 5%', 'email 10%', 'push 5%', 'push 10%','both 5%', 'both 10%','control'))

lowerbound <- min(AO_150_sales$lower.bound) - 10
upperbound <- max(AO_150_sales$upper.bound) + 10


basket_size_plot(AO_150_sales, "150", lowerbound, upperbound) + theme_ben() 

```

```{r message=FALSE, warning=FALSE}

library(tidyr)
library(gt)
post_data %>% 
  filter(tier == '150' & period == 'pre') %>% 
  select(-tier, - period, -X) %>% 
  rename(Customers = customers, Trips = trips, `Items per Trip` = items_per_trip, `Average Price per Item` = avg_price, `Basket Size` = basket_size) %>% 
  pivot_longer(-condition, names_to = c("Pre Campaign"), values_to = c("Treatment"))%>% 
  pivot_wider(names_from = condition, values_from = Treatment) %>% 
  gt() %>% 
     tab_header(
    title = "$150 Basket Tier") %>% 
  cols_label(
    Test = "Treatment") %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(1),
    decimals = 0) %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(2),
    decimals = 2) %>% 
  fmt_number(   
    columns = c(Control, Test),
    rows = c(3),
    decimals = 1) %>% 
  fmt_currency(
    columns = c(Control, Test),
    rows = c(4,5),
    decimals = 2)%>% 
  tab_footnote(
    footnote = md("Pre campaign includes the 60 days prior to the start of the campaign"), 
    locations = cells_column_labels("Pre Campaign"))
```

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(gt)
post_data %>% 
  filter(tier == '150' & period == 'during') %>% 
  select(-tier, - period, -X) %>% 
  rename(Customers = customers, Trips = trips, `Items per Trip` = items_per_trip, `Average Price per Item` = avg_price, `Basket Size` = basket_size) %>% 
  pivot_longer(-condition, names_to = c("During Campaign"), values_to = c("Treatment"))%>% 
  pivot_wider(names_from = condition, values_from = Treatment) %>% 
  gt() %>% 
     tab_header(
    title = "$150 Basket Tier") %>% 
  cols_label(
    Test = "Treatment") %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(1),
    decimals = 0) %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(2),
    decimals = 2) %>% 
  fmt_number(   
    columns = c(Control, Test),
    rows = c(3),
    decimals = 1) %>% 
  fmt_currency(
    columns = c(Control, Test),
    rows = c(4,5),
    decimals = 2) %>% 
  tab_footnote(
    footnote = md("Control and Targeted groups are nearly identical"),
    locations = cells_column_labels("Control"))
```


```{r message=FALSE, warning=FALSE}

library(dplyr)
library(ggplot2)
library(scales)

AO_200 <- target_promo %>% 
  filter(tier == '200' & customer_type == 'AO') %>% 
  group_by(push, email, five_percent, ten_percent) %>% 
  summarise(conversion = mean(AO_flag),
            customers = n(),
            SE = sd(AO_flag)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = conversion - margin.error, 
            upper.bound = conversion + margin.error) %>% 
  mutate(condition = case_when(push == 0 & email == 0 & five_percent == 0 & ten_percent == 0 ~ 'control',
                               push == 0 & email == 1 & five_percent == 1 & ten_percent == 0 ~ 'email 5%',
                               push == 0 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'email 10%',
                               push == 1 & email == 0 & five_percent == 1 & ten_percent == 0 ~ 'push 5%',
                               push == 1 & email == 0 & five_percent == 0 & ten_percent == 1 ~ 'push 10%',
                               push == 1 & email == 1 & five_percent == 1 & ten_percent == 0 ~ 'both 5%',
                               push == 1 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'both 10%')) %>% 
  ungroup() %>% 
  select(condition, conversion, lower.bound, upper.bound)


AO_200$condition <- factor(AO_200$condition, ordered = TRUE, 
                           levels = c('email 5%', 'email 10%', 'push 5%', 'push 10%','both 5%', 'both 10%','control'))

AO_200 <- AO_200%>%
  mutate(conversion_pct_rd = round(conversion, 5),
         lower_pct_rd = round(lower.bound, 5),
         upper_pct_rd = round(upper.bound, 5))

AO_200$conversion_pct_rd <- percent(AO_200$conversion_pct_rd, 1)
AO_200$lower_pct_rd <- percent(AO_200$lower_pct_rd, 1)
AO_200$upper_pct_rd <- percent(AO_200$upper_pct_rd, 1)


conversion_plot(AO_200, "200") + theme_ben()


```

```{r message=FALSE, warning=FALSE}

AO_200_sales <- target_promo %>% 
  filter(tier == '200' & AO_flag == 1 & customer_type == 'AO') %>% 
  group_by(push, email, five_percent, ten_percent) %>% 
  summarise(spend = mean(AO_sales),
            customers = n(),
            SE = sd(AO_sales)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = spend - margin.error,
            upper.bound = spend + margin.error) %>%
  mutate(condition = case_when(push == 0 & email == 0 & five_percent == 0 & ten_percent == 0 ~ 'control',
                               push == 0 & email == 1 & five_percent == 1 & ten_percent == 0 ~ 'email 5%',
                               push == 0 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'email 10%',
                               push == 1 & email == 0 & five_percent == 1 & ten_percent == 0 ~ 'push 5%',
                               push == 1 & email == 0 & five_percent == 0 & ten_percent == 1 ~ 'push 10%',
                               push == 1 & email == 1 & five_percent == 1 & ten_percent == 0 ~ 'both 5%',
                               push == 1 & email == 1 & five_percent == 0 & ten_percent == 1 ~ 'both 10%')) %>% 
  ungroup() %>% 
  select(condition, spend, lower.bound, upper.bound)


AO_200_sales <- AO_200_sales %>% 
  mutate(lower.bound.dollar = currency(lower.bound),
         upper.bound.dollar = currency(upper.bound))

AO_200_sales$condition <- factor(AO_200_sales$condition, ordered = TRUE, 
                                 levels = c('email 5%', 'email 10%', 'push 5%', 'push 10%','both 5%', 'both 10%','control'))

lowerbound <- min(AO_200_sales$lower.bound) - 10
upperbound <- max(AO_200_sales$upper.bound) + 10


basket_size_plot(AO_200_sales, "200", lowerbound, upperbound) + theme_ben() 

```

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(gt)
post_data %>% 
  filter(tier == '200' & period == 'pre') %>% 
  select(-tier, - period, -X) %>% 
  rename(Customers = customers, Trips = trips, `Items per Trip` = items_per_trip, `Average Price per Item` = avg_price, `Basket Size` = basket_size) %>% 
  pivot_longer(-condition, names_to = c("Pre Campaign"), values_to = c("Treatment"))%>% 
  pivot_wider(names_from = condition, values_from = Treatment) %>% 
  gt() %>% 
     tab_header(
    title = "$200 Basket Tier") %>% 
  cols_label(
    Test = "Treatment") %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(1),
    decimals = 0) %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(2),
    decimals = 2) %>% 
  fmt_number(   
    columns = c(Control, Test),
    rows = c(3),
    decimals = 1) %>% 
  fmt_currency(
    columns = c(Control, Test),
    rows = c(4,5),
    decimals = 2)%>% 
  tab_footnote(
    footnote = md("Pre campaign includes the 60 days prior to the start of the campaign"), 
    locations = cells_column_labels("Pre Campaign"))
```

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(gt)
post_data %>% 
  filter(tier == '200' & period == 'during') %>% 
  select(-tier, - period, -X) %>% 
  rename(Customers = customers, Trips = trips, `Items per Trip` = items_per_trip, `Average Price per Item` = avg_price, `Basket Size` = basket_size) %>% 
  pivot_longer(-condition, names_to = c("During Campaign"), values_to = c("Treatment"))%>% 
  pivot_wider(names_from = condition, values_from = Treatment) %>% 
  gt() %>% 
     tab_header(
    title = "$200 Basket Tier") %>% 
  cols_label(
    Test = "Treatment") %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(1),
    decimals = 0) %>% 
  fmt_number( 
    columns = c(Control, Test),
    rows = c(2),
    decimals = 2) %>% 
  fmt_number(   
    columns = c(Control, Test),
    rows = c(3),
    decimals = 1) %>% 
  fmt_currency(
    columns = c(Control, Test),
    rows = c(4,5),
    decimals = 2) %>% 
  tab_footnote(
    footnote = md("Control and Targeted groups are nearly identical"),
    locations = cells_column_labels("Control"))
```
\newpage
# Qualifying Purchase Analysis

* Similar to the above analysis, but limited to customers who made an AO purchase that would have qualified them to redeem the promotion (including those who did)
* We analysed the conversion rates and average order size (both in terms of dollars and items) to determine if the targeted group was more likely to make a qualifying purchase or spend more
* Differences between the control and targeted groups were not statistically significant for any of these three metrics

```{r message=FALSE, warning=FALSE}

library(gt)
library(dplyr)

summary <- qualified %>% 
  group_by(tier, promotion, condition) %>% 
  summarise(proportion = mean(qualified),
            customers = n(),
            SE = sd(qualified)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = proportion - margin.error,
            upper.bound = proportion + margin.error) %>% 
  mutate(Promotion = case_when(promotion == '0.05' ~ '5% off',
                                    promotion == '0.1' ~ '10% off',
                                    promotion == 'None' ~ 'Control')) %>% 
  ungroup() %>% 
  select(tier, Promotion, proportion, lower.bound, upper.bound)

summary$tier <- as.factor(summary$tier)

summary <- summary %>%
  mutate(proportion_pct_rd = round(proportion, 5),
         lower_pct_rd = round(lower.bound, 5),
         upper_pct_rd = round(upper.bound, 5))

summary$proportion_pct_rd <- percent(summary$proportion_pct_rd, 1)
summary$lower_pct_rd <- percent(summary$lower_pct_rd,1)
summary$upper_pct_rd <- percent(summary$upper_pct_rd, 1)

theme_milan <- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      text=element_text(size=base_size,  family="serif"),
      plot.title = element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      # Les axes
      axis.title = element_text(size = rel(0.85), face = "bold"),
      axis.text = element_text(size = rel(0.70), face = "bold"),
      axis.line = element_line(color = "black"),
      # La légende
      legend.title = element_text(size = rel(0.85), face = "bold"),
      legend.text = element_text(size = rel(0.70), face = "bold"),
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      legend.position="top",
      # Les étiquettes dans le cas d'un facetting
      strip.background = element_rect(fill = "#17252D", color = "#17252D"),
      strip.text = element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
    )
}

p <- ggplot(summary,   aes(x=tier, ymin = `lower.bound`, 
         ymax = `upper.bound`, lower = `lower.bound`,
         upper = `upper.bound`, middle = `proportion`,
         fill = Promotion)) + 
  geom_boxplot(stat = 'identity') +
  scale_fill_manual(
                    # magma with 8 classes
                    values = c("#e41a1c",
                               "#377eb8",
                               "#4daf4a",
                               "#984ea3",
                               "#ff7f00",
                               # "#ffff33",
                               "#a65628",
                               "#f781bf"))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,.1)) +
labs(title = paste0("Qualifying Basket Conversion Rate Confidence Intervals"),
       subtitle = "Differences are not statistically significant relative to control group",
       x = "Basket Tier",
       y = "Percent of Customers with a Qualifying AO Basket",
       caption = "95% Confidence Interval"
  )

p + theme_milan()

summary %>% 
  select(tier, Promotion, lower_pct_rd, upper_pct_rd) %>% 
gt() %>% 
     tab_header(
    title = "Qualifying Basket Conversion Rate Confidence Intervals") %>% 
  cols_label(
    lower_pct_rd = "Lower Bound",
    upper_pct_rd = "Upper Bound",
    tier = "") %>% 
  tab_row_group(
    label = "$100 Basket Tier",
    rows = 1:2) %>%
  tab_row_group(
    label = "$150 Basket Tier",
    rows = 3:5) %>%
  tab_row_group(
    label = "$200 Basket Tier",
    rows = 6:8) %>% 
  row_group_order(c("$100 Basket Tier", "$150 Basket Tier", "$200 Basket Tier"))

```

```{r message=FALSE, warning=FALSE}

basket_size <- qualified %>% 
  filter(qualified == 1) %>% 
  group_by(tier, promotion, condition) %>% 
summarise(average_order = mean(AO_sales, na.rm = TRUE),
            customers = n(),
            SE = sd(AO_sales)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = average_order - margin.error,
            upper.bound = average_order + margin.error) %>% 
  mutate(Promotion = case_when(promotion == '0.05' ~ '5% off',
                                    promotion == '0.1' ~ '10% off',
                                    promotion == 'None' ~ 'Control')) %>% 
  ungroup() %>% 
  select(tier, Promotion, average_order, lower.bound, upper.bound) %>% 
  rename(`Average Order` = average_order) %>% 
  ungroup()

basket_size$tier <- as.factor(basket_size$tier)

lowerbound <- min(basket_size$lower.bound) - 10
upperbound <- max(basket_size$upper.bound) + 10

theme_milan <- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      text=element_text(size=base_size,  family="serif"),
      plot.title = element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      # Les axes
      axis.title = element_text(size = rel(0.85), face = "bold"),
      axis.text = element_text(size = rel(0.70), face = "bold"),
      axis.line = element_line(color = "black"),
      # La légende
      legend.title = element_text(size = rel(0.85), face = "bold"),
      legend.text = element_text(size = rel(0.70), face = "bold"),
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      legend.position="top",
      # Les étiquettes dans le cas d'un facetting
      strip.background = element_rect(fill = "#17252D", color = "#17252D"),
      strip.text = element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
    )
}

q <- ggplot(basket_size,   aes(x=tier, ymin = `lower.bound`, 
         ymax = `upper.bound`, lower = `lower.bound`,
         upper = `upper.bound`, middle = `Average Order`,
         fill = Promotion)) + 
  geom_boxplot(stat = 'identity') +
  scale_fill_manual(
                    # magma with 8 classes
                    values = c("#e41a1c",
                               "#377eb8",
                               "#4daf4a",
                               "#984ea3",
                               "#ff7f00",
                               # "#ffff33",
                               "#a65628",
                               "#f781bf"))+
 scale_y_continuous(labels = scales::dollar_format(accuracy = 1), limits = c(lowerbound, upperbound)) +
labs(title = paste0("Average Order Confidence Intervals"),
       subtitle = "Differences are not statistically significant relative to control group",
       x = "Basket Tier",
       y = "Average Order Size",
       caption = "95% Confidence Interval"
  )

q + theme_milan()

basket_size %>% 
  select(tier, Promotion, lower.bound, upper.bound) %>% 
gt() %>% 
     tab_header(
    title = "Average Order Confidence Intervals") %>% 
  cols_label(
    lower.bound = "Lower Bound",
    upper.bound = "Upper Bound",
    tier = "") %>% 
  fmt_currency(
    columns = c(lower.bound, upper.bound),
    decimals = 2) %>% 
  tab_row_group(
    label = "$100 Basket Tier",
    rows = 1:2) %>%
  tab_row_group(
    label = "$150 Basket Tier",
    rows = 3:5) %>%
  tab_row_group(
    label = "$200 Basket Tier",
    rows = 6:8) %>% 
  row_group_order(c("$100 Basket Tier", "$150 Basket Tier", "$200 Basket Tier"))
  
```

```{r message=FALSE, warning=FALSE}
item_count <- items %>% 
  filter(qualified == 1) %>% 
  group_by(tier, promotion, condition) %>% 
  summarise(average_items = mean(items, na.rm = T),
            customers = n(),
            SE = sd(items, na.rm = T)/sqrt(customers),
            degrees.freedom = customers - 1,
            t.score = qt(p=.025, df=degrees.freedom,lower.tail=F),
            margin.error = t.score * SE,
            lower.bound = average_items - margin.error,
            upper.bound = average_items + margin.error) %>% 
  mutate(Promotion = case_when(promotion == '0.05' ~ '5% off',
                                    promotion == '0.1' ~ '10% off',
                                    promotion == 'None' ~ 'Control')) %>% 
  ungroup() %>% 
  select(tier, Promotion, average_items, lower.bound, upper.bound) %>% 
  rename(Items = average_items) %>% 
  ungroup()

item_count$tier <- as.factor(item_count$tier)

item_count <- item_count %>%
  mutate(items_pct_rd = round(Items, 1),
         lower_pct_rd = round(lower.bound, 1),
         upper_pct_rd = round(upper.bound, 1))

lowerbound <- min(item_count$lower.bound) - 10
upperbound <- max(item_count$upper.bound) + 10

theme_milan <- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      text=element_text(size=base_size,  family="serif"),
      plot.title = element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      # Les axes
      axis.title = element_text(size = rel(0.85), face = "bold"),
      axis.text = element_text(size = rel(0.70), face = "bold"),
      axis.line = element_line(color = "black"),
      # La légende
      legend.title = element_text(size = rel(0.85), face = "bold"),
      legend.text = element_text(size = rel(0.70), face = "bold"),
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      legend.position="top",
      # Les étiquettes dans le cas d'un facetting
      strip.background = element_rect(fill = "#17252D", color = "#17252D"),
      strip.text = element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
    )
}

r <-  ggplot(item_count,   aes(x=tier, ymin = `lower.bound`, 
         ymax = `upper.bound`, lower = `lower.bound`,
         upper = `upper.bound`, middle = `Items`,
         fill = Promotion)) + 
  geom_boxplot(stat = 'identity') +
  scale_fill_manual(
                    # magma with 8 classes
                    values = c("#e41a1c",
                               "#377eb8",
                               "#4daf4a",
                               "#984ea3",
                               "#ff7f00",
                               # "#ffff33",
                               "#a65628",
                               "#f781bf"))+
scale_y_continuous( limits = c(lowerbound, upperbound)) +
labs(title = paste0("Average Items per Basket Confidence Intervals"),
       subtitle = "Differences are not statistically significant relative to control group",
       x = "Basket Tier",
       y = "Average Number of Items",
       caption = "95% Confidence Interval"
  )

r + theme_milan()

item_count %>% 
  select(tier, Promotion, lower.bound, upper.bound) %>% 
gt() %>% 
     tab_header(
    title = "Average Items per Basket Confidence Intervals") %>% 
  cols_label(
    lower.bound = "Lower Bound",
    upper.bound = "Upper Bound",
    tier = "") %>% 
  fmt_number(
    columns = c(lower.bound, upper.bound),
    decimals = 1) %>% 
  tab_row_group(
    label = "$100 Basket Tier",
    rows = 1:2) %>%
  tab_row_group(
    label = "$150 Basket Tier",
    rows = 3:5) %>%
  tab_row_group(
    label = "$200 Basket Tier",
    rows = 6:8) %>% 
  row_group_order(c("$100 Basket Tier", "$150 Basket Tier", "$200 Basket Tier"))
```
\newpage

# Pre-post analysis
* To determine whether engaging with the promotion altered customers' behavior after the promotion, we examined the weekly AO behavior of customers who redeemed the promotion and customers in the control group who made a qualifying purchase
* We found that the customers who redeemed did not behave significantly differently than the control group with respect to sales, baskets, or number of items during the three weeks following the promotion


```{r message=FALSE, warning=FALSE}

require(reshape2)
library(gt)

diff$period <- factor(diff$period, levels = c("Pre", "Post"), ordered = T)

pre_post_all <- diff %>% 
  group_by(FYWeekEndingDate, period,tier, group) %>% 
  summarise(PotentialCustomers = n()) %>%
  dplyr::left_join(diff %>%
                     dplyr::filter(sales >0) %>%
                     group_by(FYWeekEndingDate, period,tier, group) %>%
                     dplyr::summarize(customers = n(),
                                      sales = mean(sales),
                                      baskets = mean(baskets),
                                      items = mean(items))) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(period,tier, group) %>%
  dplyr::summarize(PotentialCustomers = mean(PotentialCustomers),
                   customers = mean(customers),
                   sales = mean(sales),
                   baskets = mean(baskets),
                   items = mean(items)) %>%
  dplyr::mutate(purchase_pct = customers/PotentialCustomers) %>% 
  dplyr::select(tier, period, group, PotentialCustomers, customers, 
                purchase_pct, sales, baskets, items) %>% 
  arrange(tier, period, group) %>% 
  ungroup()

pre_post_all %>% 
  select(-tier) %>% 
  gt() %>% 
     tab_header(
    title = "Pre- and Post-Promotion Behavior by Tier and Group",
    subtitle = "Due to small sample, differences are not statistically significant") %>% 
  cols_label(
    group = "Group",
    period = "Period",
    # tier = "",
    PotentialCustomers = "Total Customers",
    customers = "Purchasing Customers", 
    purchase_pct = "Purchase Percentage",
    sales = "Sales",
    baskets = "Baskets",
    items = "Items") %>% 
  fmt_number(
    columns = c(baskets, items),
    decimals = 1) %>% 
  fmt_number(
    columns = c(PotentialCustomers, customers),
    decimals = 0) %>% 
  fmt_currency(
    columns = c(sales),
    decimals = 2) %>%
  fmt_percent(
    columns = c(purchase_pct),
    decimals = 0) %>% 
  tab_row_group(
    label = "$100 Basket Tier",
    rows = 1:4) %>%
  tab_row_group(
    label = "$150 Basket Tier",
    rows = 5:8) %>%
  tab_row_group(
    label = "$200 Basket Tier",
    rows = 9:12) %>% 
  row_group_order(c("$100 Basket Tier", "$150 Basket Tier", "$200 Basket Tier"))
  # tab_footnote(
  #   footnote = md("Due to small sample, differences are not statistically significant"),
  #   locations = cells_column_labels("Period"))



```

